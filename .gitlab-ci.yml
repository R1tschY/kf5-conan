# Global things
cache:
  key: '$ARCH'
  paths:
    - .venv-$ARCH/
variables:
  CONAN_CHANNEL: stable
  CONAN_LOGIN_USERNAME: r1tschy
  CONAN_USERNAME: r1tschy
  CONAN_UPLOAD: https://api.bintray.com/conan/r1tschy/sailfishos@1@sailfishos
before_script:
  # route /builds to sb2
  - echo 'use_outside_path("/builds")' > $HOME/.sbrules
  # /builds with target exec policy
  - sudo sed -i 's%sbox_user_home_dir%"/builds", exec_policy_name = "Target"},{dir = sbox_user_home_dir%' /usr/share/scratchbox2/modes/sdk-build/config.lua

  # Install python devel to compile python packages
  - 'dev/installenv $ARCH zypper -qn in cmake openssl-devel python3-devel $EXTRA_DEPS'
  # Create conan venv
  - 'dev/buildenv $ARCH dev/commands/prepare-buildenv'

# -- JOBS --
kcoreaddons armv7hl:
  image: "coderus/sailfishos-platform-sdk:latest"
  variables:
    ARCH: "armv7hl"
    EXTRA_DEPS: "'extra-cmake-modules' 'pkgconfig(Qt5Test)'"
  script:
    - "dev/buildenv $ARCH python ci_build.py kcoreaddons"
  only:
    changes:
      - "kcoreaddons/**/*"

kcoreaddons i486:
  image: "coderus/sailfishos-platform-sdk:latest"
  variables:
    ARCH: "i486"
    EXTRA_DEPS: "'extra-cmake-modules' 'pkgconfig(Qt5Test)'"
  script:
    - "dev/buildenv $ARCH python ci_build.py kcoreaddons"
  only:
    changes:
      - "kcoreaddons/**/*"

ki18n armv7hl:
  image: "coderus/sailfishos-platform-sdk:latest"
  variables:
    ARCH: "armv7hl"
    EXTRA_DEPS: "'extra-cmake-modules' 'pkgconfig(Qt5Test)' 'pkgconfig(Qt5Script)' 'gettext-devel'"
  script:
    - "dev/buildenv $ARCH python ci_build.py ki18n"
  only:
    changes:
      - "ki18n/**/*"

ki18n i486:
  image: "coderus/sailfishos-platform-sdk:latest"
  variables:
    ARCH: "i486"
    EXTRA_DEPS: "'extra-cmake-modules' 'pkgconfig(Qt5Test)' 'pkgconfig(Qt5Script)' 'gettext-devel'"
  script:
    - "dev/buildenv $ARCH python ci_build.py ki18n"
  only:
    changes:
      - "ki18n/**/*"

libssh armv7hl:
  image: "coderus/sailfishos-platform-sdk:latest"
  variables:
    ARCH: "armv7hl"
    EXTRA_DEPS: "'pkgconfig(openssl)'"
  script:
    - "dev/buildenv $ARCH python ci_build.py libssh"
  only:
    changes:
      - "libssh/**/*"

libssh i486:
  image: "coderus/sailfishos-platform-sdk:latest"
  variables:
    ARCH: "i486"
    EXTRA_DEPS: "'pkgconfig(openssl)'"
  script:
    - "dev/buildenv $ARCH python ci_build.py libssh"
  only:
    changes:
      - "libssh/**/*"